<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>New Story</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.min.css" />
  </head>
  <body>
    <h1><a href="/">Dendrite</a></h1>
    <h2>New story</h2>
    <form
      action="https://europe-west1-irien-465710.cloudfunctions.net/prod-submit-new-story"
      method="post"
      enctype="multipart/form-data"
    >
      <div>
        <label>Title <input type="text" name="title" /></label>
      </div>
      <div>
        <label>Content <textarea name="content"></textarea></label>
      </div>
      <div>
        <label>Author <input type="text" name="author" /></label>
      </div>
      <div>
        <label>Option 1 <input type="text" name="option0" /></label>
      </div>
      <div>
        <label>Option 2 <input type="text" name="option1" /></label>
      </div>
      <div>
        <label>Option 3 <input type="text" name="option2" /></label>
      </div>
      <div>
        <label>Option 4 <input type="text" name="option3" /></label>
      </div>
      <div>
        <button type="submit">Submit</button>
      </div>
      <p id="saving" style="display: none;">Saving...</p>
    </form>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector("form");
        const button = form.querySelector("button[type='submit']");
        const saving = document.getElementById("saving");

        form.addEventListener("submit", async event => {
          event.preventDefault();
          button.disabled = true;
          saving.style.display = "block";
          let dots = 1;
          saving.textContent = "Saving.";
          const intervalId = setInterval(() => {
            dots = (dots % 3) + 1;
            saving.textContent = `Saving${".".repeat(dots)}`;
          }, 500);

          try {
            const formData = new FormData(form);
            const response = await fetch(form.action, {
              method: form.method,
              body: formData,
            });
            if (!response.ok) {
              throw new Error("Submission failed");
            }
            const { id } = await response.json();
            let delay = 500;
            while (true) {
              await new Promise(resolve => setTimeout(resolve, delay));
              const pendingRes = await fetch(`/pending/${id}.json`);
              if (pendingRes.ok) {
                const data = await pendingRes.json();
                clearInterval(intervalId);
                window.location.href = data.path;
                return;
              }
              delay = Math.min(delay * 2, 8000);
            }
          } catch (err) {
            clearInterval(intervalId);
            saving.textContent = "Failed to save.";
            button.disabled = false;
          }
        });
      });
    </script>
  </body>
</html>
