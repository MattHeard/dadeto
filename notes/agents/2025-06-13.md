# Process new page target reuse test

- **Surprise:** Reusing the shared story hierarchy helper leaves `pageDocRef.get` undefined by default, so the test would silently skip fetching the existing target page without an explicit mock. Remember to stub the getter anytime we exercise branches that inspect stored page data.
- **Diagnosis:** The handler still succeeded during dry runs, but `findAvailablePageNumberFn` fired because the context fell through to page creation. Watching the batch interactions revealed we needed `pageDocRef.get` to resolve a truthy snapshot before the existing context short-circuited page creation.
- **Guidance:** When validating behavior around `resolveExistingPageContext`, always assert both `pageDocRef.get` and the page-number finder to confirm which branch executed. That guards against regressions where the handler unexpectedly creates new pages.
- **Follow-up:** Consider extracting a dedicated factory for `pageDocRef` variants (existing vs. new page) so future tests don't have to override mocks manually.
