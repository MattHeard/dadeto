After digging through the newest jscpd report (minTokens still at 35), the remaining cloud duplication was the pair between `mark-variant-dirty` and `submit-new-page` where both files build the same Firestore queries for pages and variants. That redundancy was easy to miss because the logic lived inside larger helper stacks, so the clone report only flagged five-line snippets. I pulled that shared query-building logic into `src/core/cloud/firestore-helpers.js` so both modules can call a single builder before they add their own snapshot handling.

The unexpected part was realizing that mark-variant-dirty intentionally exposes snapshots instead of refs, so I kept the new helpers focused on the query structure and left the existing snapshot/ref helpers intact rather than trying to unify reference extraction. Exporting just the query builders kept the duplication report quiet without forcing either caller to reshape its return value.

Tests and duplication now run cleanly after the change. No further follow-up is required, but if future duplication reports land on other cloud functions, a good first step is to look for these small Firestore query patternsâ€”they tend to trip the tool because they are implemented straight inside each helper. Open question: should we generalize these query builders to other Firestore lookups in the cloud layer to keep the tool from resurfacing similar clones later?
