<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dadeto Writer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Instrument+Serif:ital@0;1&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f3efe3;
        --bg-accent: #e2d5bb;
        --panel: rgba(255, 252, 245, 0.88);
        --ink: #1d261f;
        --muted: #5d665f;
        --line: rgba(29, 38, 31, 0.14);
        --strong-line: rgba(29, 38, 31, 0.28);
        --accent: #a03c2f;
        --accent-soft: rgba(160, 60, 47, 0.14);
        --success: #2d6a4f;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        color: var(--ink);
        font-family: 'IBM Plex Mono', monospace;
        background:
          radial-gradient(circle at top left, rgba(160, 60, 47, 0.16), transparent 28rem),
          linear-gradient(135deg, var(--bg), #efe6d2 56%, var(--bg-accent));
      }

      .shell {
        width: min(1100px, calc(100vw - 2rem));
        margin: 1rem auto;
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 1rem;
      }

      .masthead,
      .editor-panel {
        border: 1px solid var(--strong-line);
        background: var(--panel);
        backdrop-filter: blur(10px);
        box-shadow: 0 18px 48px rgba(29, 38, 31, 0.08);
      }

      .masthead {
        padding: 1.25rem 1.25rem 1rem;
      }

      h1 {
        margin: 0;
        font-family: 'Instrument Serif', serif;
        font-size: clamp(2.3rem, 6vw, 4.7rem);
        font-weight: 400;
        line-height: 0.92;
        letter-spacing: 0.02em;
      }

      .subhead {
        margin: 0.75rem 0 0;
        max-width: 42rem;
        color: var(--muted);
        line-height: 1.5;
      }

      .status-row {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .pill {
        padding: 0.35rem 0.6rem;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.55);
      }

      .save-state.saving {
        color: var(--accent);
      }

      .save-state.saved {
        color: var(--success);
      }

      .editor-panel {
        overflow: hidden;
      }

      textarea {
        display: block;
        width: 100%;
        min-height: calc(100vh - 15rem);
        border: 0;
        padding: 1.25rem;
        resize: vertical;
        background:
          linear-gradient(transparent 0, transparent calc(1.7rem - 1px), rgba(29, 38, 31, 0.06) calc(1.7rem - 1px), rgba(29, 38, 31, 0.06) 1.7rem);
        background-size: 100% 1.7rem;
        color: var(--ink);
        font: 500 1rem/1.7 'IBM Plex Mono', monospace;
        caret-color: var(--accent);
      }

      textarea:focus {
        outline: none;
        box-shadow: inset 0 0 0 2px var(--accent-soft);
      }

      @media (max-width: 720px) {
        .shell {
          width: min(100vw, calc(100vw - 1rem));
          margin: 0.5rem auto;
        }

        .masthead,
        textarea {
          padding: 1rem;
        }

        textarea {
          min-height: calc(100vh - 13rem);
        }
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <section class="masthead">
        <h1>Dadeto Writer</h1>
        <p class="subhead">
          A local markdown draft pad. It reloads from disk on open and autosaves
          your changes every second.
        </p>
        <div class="status-row">
          <span class="pill" id="file-path">Loading file…</span>
          <span class="save-state" id="save-state">Loading…</span>
        </div>
      </section>
      <section class="editor-panel">
        <textarea
          id="editor"
          spellcheck="false"
          placeholder="# Start writing"
          aria-label="Markdown editor"
        ></textarea>
      </section>
    </main>
    <script type="module">
      const editor = document.getElementById('editor');
      const saveState = document.getElementById('save-state');
      const filePath = document.getElementById('file-path');

      let lastSavedValue = '';
      let isLoaded = false;

      const setSaveState = (message, className = '') => {
        saveState.textContent = message;
        saveState.className = `save-state ${className}`.trim();
      };

      const loadDocument = async () => {
        const response = await fetch('/api/writer/document');
        if (!response.ok) {
          throw new Error('Failed to load document');
        }

        const payload = await response.json();
        editor.value = payload.content;
        lastSavedValue = payload.content;
        filePath.textContent = payload.documentPath;
        setSaveState('Loaded', 'saved');
        isLoaded = true;
      };

      const saveDocument = async () => {
        const currentValue = editor.value;

        if (!isLoaded || currentValue === lastSavedValue) {
          return;
        }

        setSaveState('Saving…', 'saving');

        const response = await fetch('/api/writer/document', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ content: currentValue }),
        });

        if (!response.ok) {
          throw new Error('Failed to save document');
        }

        const payload = await response.json();
        lastSavedValue = currentValue;
        filePath.textContent = payload.documentPath;
        setSaveState(`Saved ${new Date(payload.savedAt).toLocaleTimeString()}`, 'saved');
      };

      loadDocument().catch(error => {
        setSaveState(error.message, 'saving');
      });

      window.setInterval(() => {
        saveDocument().catch(error => {
          setSaveState(error.message, 'saving');
        });
      }, 1000);
    </script>
  </body>
</html>
